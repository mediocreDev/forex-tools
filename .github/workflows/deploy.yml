name: Deploy project to VPS

on:
  pull_request:
    types: [closed]
    branches:
      - dev
      - uat
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ”§ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸŒ Set environment name
        id: vars
        run: |
          if [[ "${GITHUB_REF_NAME}" == "dev" ]]; then
            echo "ENV_NAME=development" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF_NAME}" == "uat" ]]; then
            echo "ENV_NAME=uat" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF_NAME}" == "master" ]]; then
            echo "ENV_NAME=production" >> $GITHUB_OUTPUT
          else
            echo "ENV_NAME=unknown" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ—ï¸ Build Vue app
        run: |
          echo "Building for ${{ steps.vars.outputs.ENV_NAME }} environment..."
          if [[ "${GITHUB_REF_NAME}" == "dev" ]]; then
            npm run build:dev
          elif [[ "${GITHUB_REF_NAME}" == "uat" ]]; then
            npm run build:uat
          elif [[ "${GITHUB_REF_NAME}" == "master" ]]; then
            npm run build
          else
            echo "âŒ Unsupported branch: ${GITHUB_REF_NAME}"
            exit 1
          fi

      - name: ğŸ“‹ Check build outputs
        run: |
          echo "ğŸ“‚ Vue dist/"
          ls -lah dist || echo "âŒ dist/ missing"
          echo "ğŸ“‚ Proxy backend"
          ls -lah proxy || echo "âŒ proxy/ missing"
          echo "ğŸ“„ package files"
          ls -l package.json package-lock.json || echo "âŒ package files missing"
      
      - name: ğŸ§¹ Clean remote folder before deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 1993
          script: |
            rm -rf /var/www/forextool-${{ github.ref_name }}/*

      - name: ğŸ“¤ Upload project to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 1993
          source: "dist, proxy, package.json"
          target: "/var/www/forextool-${{ github.ref_name }}"

      - name: ğŸš€ Run post-deploy commands (install, PM2, nginx)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 1993
          script: |
            set -e
            cd /var/www/forextool-${{ github.ref_name }}

            echo "ğŸ“¦ Installing dependencies..."
            npm install

            echo "ğŸ“¥ Installing PM2 if needed..."
            command -v pm2 || sudo npm install -g pm2

            echo "ğŸ”Œ Mapping branch to port..."
            if [[ "${{ github.ref_name }}" == "dev" ]]; then
              PORT=3001
            elif [[ "${{ github.ref_name }}" == "uat" ]]; then
              PORT=3002
            elif [[ "${{ github.ref_name }}" == "master" ]]; then
              PORT=3003
            else
              PORT=3999
            fi
            echo "âœ… Selected PORT: $PORT"

            echo "ğŸ§¹ Cleaning previous PM2 process..."
            pm2 stop forextool-${{ github.ref_name }}-api || true
            pm2 delete forextool-${{ github.ref_name }}-api || true

            echo "ğŸš€ Starting Express backend on PORT=$PORT..."
            PORT=$PORT pm2 start proxy/index.js \
              --name forextool-${{ github.ref_name }}-api \
              --update-env

            echo "ğŸ’¾ Saving PM2 state..."
            pm2 save

            echo "â™»ï¸ Reloading NGINX..."
            sudo systemctl reload nginx

            echo "ğŸ§ª PM2 Process List:"
            pm2 list

            echo "ğŸ“œ Last 20 log lines:"
            pm2 logs forextool-${{ github.ref_name }}-api --lines 20 --nostream

            echo "ğŸ“¡ Health check on http://localhost:$PORT/health..."
            curl -s http://localhost:$PORT/health || echo "âŒ Express not responding on port $PORT"
